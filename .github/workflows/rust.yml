# Rust CI/CD Pipeline (PLACEHOLDER)
# This workflow is ready for instant activation when Rust files are added
# Handles crates.io publishing with automated cargo build/test/lint
# 
# TO ACTIVATE: Add Cargo.toml to the repository root
# Supports: clippy lint, rustfmt, test, build, and automated crates.io publishing

name: Rust

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: write

# Auto-cancel obsolete workflow runs
concurrency:
  group: rust-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Check if Rust files exist
  check-rust-files:
    name: Check for Rust Files
    runs-on: ubuntu-latest
    outputs:
      has_rust: ${{ steps.check.outputs.has_rust }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for Cargo.toml or .rs files
      id: check
      run: |
        if [ -f "Cargo.toml" ] || find . -name "*.rs" | grep -q .; then
          echo "has_rust=true" >> $GITHUB_OUTPUT
          echo "Rust files detected"
        else
          echo "has_rust=false" >> $GITHUB_OUTPUT
          echo "No Rust files found - workflow will skip"
        fi

  # Lint Rust code with Clippy
  clippy:
    name: Clippy Lint
    runs-on: ubuntu-latest
    needs: check-rust-files
    if: needs.check-rust-files.outputs.has_rust == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: clippy
        
    - name: Run Clippy
      run: cargo clippy --all-targets --all-features -- -D warnings

  # Check code formatting
  rustfmt:
    name: Code Formatting Check
    runs-on: ubuntu-latest
    needs: check-rust-files
    if: needs.check-rust-files.outputs.has_rust == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: rustfmt
        
    - name: Check formatting
      run: cargo fmt --all -- --check

  # Run tests with coverage
  test:
    name: Test Rust Code
    runs-on: ${{ matrix.os }}
    needs: check-rust-files
    if: needs.check-rust-files.outputs.has_rust == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable, beta]
        exclude:
          # Run beta only on Linux
          - os: windows-latest
            rust: beta
          - os: macos-latest
            rust: beta
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: ${{ matrix.rust }}
        
    - name: Build project
      run: cargo build --verbose
      
    - name: Run tests
      run: cargo test --verbose
      
    - name: Run tests with coverage (Linux stable only)
      if: matrix.os == 'ubuntu-latest' && matrix.rust == 'stable'
      run: |
        cargo install cargo-tarpaulin
        cargo tarpaulin --out Xml --output-dir coverage
        
    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.rust == 'stable'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/cobertura.xml
        flags: rust
        name: codecov-rust

  # Security audit for dependencies
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: check-rust-files
    if: needs.check-rust-files.outputs.has_rust == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      
    - name: Install cargo-audit
      run: cargo install cargo-audit
      
    - name: Run security audit
      run: cargo audit
      continue-on-error: true

  # Build release binaries
  build:
    name: Build Release
    runs-on: ${{ matrix.os }}
    needs: [clippy, rustfmt, test]
    if: needs.check-rust-files.outputs.has_rust == 'true'
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        
    - name: Build release
      run: cargo build --release --verbose
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rust-build-${{ matrix.os }}
        path: target/release/
        retention-days: 7

  # Publish to crates.io
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: build
    if: |
      needs.check-rust-files.outputs.has_rust == 'true' && 
      github.event_name == 'push' && 
      startsWith(github.ref, 'refs/tags/v')
    
    environment:
      name: crates-io
      url: https://crates.io/crates/snell-vern-matrix
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        
    - name: Login to crates.io
      run: cargo login ${{ secrets.CRATES_IO_TOKEN }}
      
    - name: Publish to crates.io
      run: cargo publish --allow-dirty
      continue-on-error: true

  # Generate and publish documentation
  docs:
    name: Build and Publish Docs
    runs-on: ubuntu-latest
    needs: check-rust-files
    if: |
      needs.check-rust-files.outputs.has_rust == 'true' && 
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        
    - name: Build documentation
      run: cargo doc --no-deps --all-features
      
    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: rust-docs
        path: target/doc/
        retention-days: 30

# SETUP INSTRUCTIONS FOR ACTIVATION:
# 
# 1. Create Cargo.toml with:
#    [package]
#    name = "snell-vern-matrix"
#    version = "0.1.0"
#    edition = "2021"
#    authors = ["wizardaax"]
#    license = "MIT"
#    description = "Unified Drive Matrix Engine for recursive field computations"
#    repository = "https://github.com/wizardaax/Snell-Vern-Hybrid-Drive-Matrix"
#
# 2. Add CRATES_IO_TOKEN secret to GitHub repository settings
#    - Get token from https://crates.io/me/settings/tokens
#    - Add as repository secret named CRATES_IO_TOKEN
#
# 3. Create src/lib.rs or src/main.rs with Rust implementation
#
# 4. Add tests in tests/ directory or inline with #[cfg(test)]
#
# 5. Ensure Cargo.toml has proper metadata for publishing:
#    - keywords (max 5)
#    - categories
#    - readme = "README.md"
#    - homepage (optional)
#    - documentation (optional)
#
# 6. Run `cargo publish --dry-run` locally to verify before first publish
