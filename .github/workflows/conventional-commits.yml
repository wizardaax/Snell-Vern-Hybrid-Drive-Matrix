# Conventional Commits Validation Workflow
# Ensures all commit messages follow conventional commit format
# Enforces semantic commit messages: feat:, fix:, docs:, etc.
# Helps with automated versioning and changelog generation

name: Conventional Commits

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write

# Auto-cancel obsolete workflow runs
concurrency:
  group: commits-${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Validate PR title follows conventional commits
  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    
    steps:
    - name: Validate PR Title Format
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        # Allowed types
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
          revert
        # Allowed scopes (optional)
        scopes: |
          core
          api
          cli
          docs
          deps
          security
          ci
        # Require scope (set to false to make optional)
        requireScope: false
        # Validate subject is not empty
        subjectPattern: ^(?![A-Z]).+$
        subjectPatternError: |
          The subject "{subject}" found in the pull request title "{title}"
          should start with a lowercase letter.

  # Validate commit messages
  validate-commits:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history to check all commits
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install commitlint
      run: |
        npm install -g @commitlint/cli @commitlint/config-conventional
        
    - name: Create commitlint config
      run: |
        cat > commitlint.config.js << 'EOF'
        module.exports = {
          extends: ['@commitlint/config-conventional'],
          rules: {
            'type-enum': [2, 'always', [
              'feat',     // New feature
              'fix',      // Bug fix
              'docs',     // Documentation only
              'style',    // Code style (formatting, etc)
              'refactor', // Code refactoring
              'perf',     // Performance improvement
              'test',     // Adding/updating tests
              'build',    // Build system or dependencies
              'ci',       // CI configuration
              'chore',    // Other changes
              'revert'    // Revert a commit
            ]],
            'subject-case': [2, 'always', 'sentence-case'],
            'header-max-length': [2, 'always', 100]
          }
        };
        EOF
        
    - name: Validate commits
      run: |
        # Get all commits in this PR
        git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%H %s" | while read hash message; do
          echo "Validating: $message"
          echo "$message" | npx commitlint
        done

  # Provide helpful feedback
  provide-guidance:
    name: Provide Conventional Commit Guidance
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: Comment PR with guidance
      uses: actions/github-script@v7
      with:
        script: |
          const message = `
          ## ðŸ“ Conventional Commit Format Required
          
          This PR requires conventional commit format for all commits and the PR title.
          
          ### Format:
          \`\`\`
          <type>(<scope>): <subject>
          
          <body>
          
          <footer>
          \`\`\`
          
          ### Valid Types:
          - \`feat\`: New feature
          - \`fix\`: Bug fix
          - \`docs\`: Documentation changes
          - \`style\`: Code style/formatting
          - \`refactor\`: Code refactoring
          - \`perf\`: Performance improvements
          - \`test\`: Test changes
          - \`build\`: Build system changes
          - \`ci\`: CI/CD changes
          - \`chore\`: Other changes
          - \`revert\`: Revert previous commit
          
          ### Examples:
          \`\`\`
          feat: add automated PyPI publishing workflow
          fix(ci): correct coverage report upload path
          docs: update README with workflow badges
          chore(deps): update GitHub Actions to v4
          \`\`\`
          
          ### Breaking Changes:
          Add \`BREAKING CHANGE:\` in the commit body or use \`!\` after type:
          \`\`\`
          feat!: redesign API structure
          
          BREAKING CHANGE: API endpoints have been restructured
          \`\`\`
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });

# CONVENTIONAL COMMIT GUIDELINES:
# 
# Type Guidelines:
# - feat:     Use for new features or capabilities
# - fix:      Use for bug fixes
# - docs:     Use for documentation-only changes
# - style:    Use for code formatting (no logic changes)
# - refactor: Use for code restructuring (no behavior change)
# - perf:     Use for performance improvements
# - test:     Use for adding or updating tests
# - build:    Use for build system or dependency changes
# - ci:       Use for CI/CD pipeline changes
# - chore:    Use for maintenance tasks
# - revert:   Use for reverting previous commits
#
# Scope Guidelines (optional but recommended):
# - core:     Core library functionality
# - api:      Public API changes
# - cli:      Command-line interface
# - docs:     Documentation
# - deps:     Dependencies
# - security: Security-related changes
# - ci:       CI/CD workflows
#
# Benefits:
# - Automated changelog generation
# - Semantic version bumping
# - Better commit history readability
# - Easier code review
# - Automated release notes
